<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retail Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold">Retail Management System</h1>
            <div>
                <span class="mr-4">Welcome, {{ username }}!</span>
                <a href="{{ url_for('logout') }}" class="text-blue-500 hover:underline">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Products Section -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Products</h2>

                <div class="bg-gray-50 p-4 rounded-lg mb-6 border">
                    <h3 class="text-lg font-semibold mb-2">Add Product by ID</h3>
                    <form onsubmit="addToCartById(event)" class="flex items-center gap-2">
                        <input type="number" name="product_id" placeholder="Product ID" class="w-28 p-2 border rounded-md" required>
                        <input type="number" name="quantity" value="1" min="1" class="w-20 p-2 border rounded-md" required>
                        <button type="submit" class="bg-gray-700 text-white px-4 py-2 rounded-md hover:bg-gray-800 transition">Add</button>
                    </form>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for product in products %}
                    <div class="border p-4 rounded-lg flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-baseline">
                                <h3 class="text-lg font-bold">{{ product.name }}</h3>
                                <span class="text-sm font-semibold text-gray-500">ID: {{ product.productID }}</span>
                            </div>
                            <p class="text-gray-600 my-2">{{ product.description }}</p>
                        </div>
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-xl font-semibold text-gray-800">${{ "%.2f"|format(product.price) }}</span>
                            <span class="text-sm text-gray-500">Stock: {{ product.stock }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Cart Section -->
            <div class="bg-white p-6 rounded-xl shadow-md self-start">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Shopping Cart</h2>
                <div id="cart-items" class="mb-4">
                    <!-- Cart items will be rendered here -->
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-lg font-bold">Total:</span>
                        <span id="cart-total" class="text-xl font-bold">$0.00</span>
                    </div>
                    <form onsubmit="purchase(event)">
                        <div class="mb-4">
                            <label for="payment_method" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                            <select id="payment_method" name="payment_method" class="w-full p-2 border rounded-md">
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">Complete Purchase</button>
                    </form>
                    <button onclick="clearCart()" class="w-full bg-red-500 text-white mt-2 px-4 py-2 rounded-md hover:bg-red-600 transition">Cancel Sale</button>
                </div>
            </div>
        </div>

        <!-- Latest Purchases Section -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Latest Purchases</h2>
            <div class="space-y-4">
                {% if recent_sales %}
                    {% for sale in recent_sales %}
                        <div class="p-4 border rounded-lg bg-gray-50">
                            <div class="flex justify-between items-center">
                                <p class="font-bold">Sale #{{ sale.saleID }}</p>
                                <p class="text-sm text-gray-500">{{ sale.sale_date.strftime('%Y-%m-%d %H:%M') }}</p>
                            </div>
                            <ul class="list-disc list-inside mt-2 text-sm">
                                {% for item in sale.items %}
                                    <li>{{ item.product.name }} (x{{ item.quantity }})</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500">No recent sales to display.</p>
                {% endif %}
            </div>
        </div>

    </div>

    <script>
        function showMessage(message, isError = false, specialAction = null) {
            document.querySelectorAll('.notification-popup').forEach(p => p.remove());

            const popup = document.createElement('div');
            const bgColor = isError ? 'bg-red-500' : 'bg-green-500';
            popup.className = `notification-popup fixed top-5 right-5 p-4 rounded-md shadow-lg text-white flex flex-col items-start gap-2 z-50 ${bgColor}`;
            
            const messageContainer = document.createElement('div');
            messageContainer.className = 'flex items-center justify-between w-full';

            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;

            const closeButton = document.createElement('button');
            closeButton.innerHTML = '&times;';
            closeButton.className = 'font-bold text-xl leading-none hover:text-gray-200';
            closeButton.onclick = () => popup.remove();
            
            messageContainer.appendChild(messageSpan);
            messageContainer.appendChild(closeButton);
            popup.appendChild(messageContainer);

            if (isError && specialAction) {
                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex gap-2 mt-2';
                
                const reduceBtn = document.createElement('button');
                reduceBtn.textContent = `Reduce to ${specialAction.available_stock}`;
                reduceBtn.className = 'bg-blue-600 text-white px-2 py-1 rounded-md text-sm hover:bg-blue-700';
                reduceBtn.onclick = () => {
                    setCartQuantity(specialAction.product_id, specialAction.available_stock);
                    popup.remove();
                };

                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Remove Item';
                removeBtn.className = 'bg-gray-700 text-white px-2 py-1 rounded-md text-sm hover:bg-gray-800';
                removeBtn.onclick = () => {
                    removeFromCart(specialAction.product_id);
                    popup.remove();
                };

                actionDiv.appendChild(reduceBtn);
                actionDiv.appendChild(removeBtn);
                popup.appendChild(actionDiv);
            }
            
            document.body.appendChild(popup);

            if (!isError) {
                setTimeout(() => popup.remove(), 4000);
            }
        }

        function renderCart(cartData) {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalElement = document.getElementById('cart-total');
            
            cartItemsContainer.innerHTML = '';

            if (cartData && cartData.items && cartData.items.length > 0) {
                cartData.items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center py-2 border-b';
                    itemDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name} (x${item.quantity})</p>
                            <p class="text-sm text-gray-500">@ $${parseFloat(item.price).toFixed(2)}</p>
                        </div>
                        <p class="font-semibold">$${parseFloat(item.subtotal).toFixed(2)}</p>
                    `;
                    cartItemsContainer.appendChild(itemDiv);
                });
                cartTotalElement.textContent = `$${parseFloat(cartData.total).toFixed(2)}`;
            } else {
                cartItemsContainer.innerHTML = '<p class="text-gray-500">Your cart is empty.</p>';
                cartTotalElement.textContent = '$0.00';
            }
        }
        
        async function addToCartById(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch('/add_to_cart', { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok) {
                    showMessage('Item added to cart!');
                    renderCart(result.cart);
                    form.reset();
                } else {
                    if (result.type === 'INSUFFICIENT_STOCK') {
                        showMessage(result.error, true, {
                            product_id: result.product_id,
                            available_stock: result.available_stock
                        });
                    } else {
                        showMessage(result.error, true);
                    }
                }
            } catch (error) {
                console.error('Add to cart failed:', error);
                showMessage('An error occurred.', true);
            }
        }
        
        async function clearCart() {
            try {
                const response = await fetch('/clear_cart', { method: 'POST' });
                const result = await response.json();
                if (response.ok) {
                    showMessage('Sale cancelled and cart cleared!');
                    renderCart(result.cart);
                } else {
                    showMessage(result.error, true);
                }
            } catch (error) {
                console.error('Clear cart failed:', error);
                showMessage('An error occurred.', true);
            }
        }

        async function purchase(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const response = await fetch('/purchase', { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok) {
                    showMessage('Purchase successful! Redirecting...');
                    setTimeout(() => {
                        window.location.href = result.receipt_url;
                    }, 1500);
                } else {
                    // --- CHANGE HIGHLIGHT: Handle concurrency conflict by reloading the page ---
                    showMessage(result.error, true);
                    // If the server returns a 409 Conflict status, it means stock changed.
                    // We reload the page to show the user the updated stock levels.
                    if (response.status === 409) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 4000); // Wait 4 seconds for the user to read the message
                    }
                    // --- END CHANGE ---
                }
            } catch (error) {
                console.error('Purchase failed:', error);
                showMessage('An error occurred.', true);
            }
        }

        async function removeFromCart(productId) {
            const formData = new FormData();
            formData.append('product_id', productId);
            try {
                const response = await fetch('/remove_from_cart', { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok) {
                    showMessage('Item removed from cart.');
                    renderCart(result.cart);
                } else {
                    showMessage(result.error, true);
                }
            } catch (error) {
                showMessage('An error occurred.', true);
            }
        }

        async function setCartQuantity(productId, quantity) {
            const formData = new FormData();
            formData.append('product_id', productId);
            formData.append('quantity', quantity);
            try {
                const response = await fetch('/set_cart_quantity', { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok) {
                    showMessage(`Quantity set to ${quantity}.`);
                    renderCart(result.cart);
                } else {
                    showMessage(result.error, true);
                }
            } catch (error) {
                showMessage('An error occurred.', true);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const initialCart = {{ cart | tojson }};
            const initialTotal = {{ total | tojson }};
            renderCart({ items: initialCart, total: initialTotal });
        });
    </script>

</body>
</html>

